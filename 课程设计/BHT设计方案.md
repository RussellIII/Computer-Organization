# BHT设计方案

* 外部指令地址有：IF.PC、ID.PC、EX.PC、正常指令地址



## BHT根据IF.PC给出下一条指令地址

* IF.PC作为PCin输入BHT封装电路
* IRPC==PCin && V 才可判定为命中
* 命中后对应位置LRU清零
* 命中且预判历史大于1：下一条指令地址为存储的TargetPC
* 命中且预判历史不大于1：下一条指令地址为IF.PC+4
* 全部未命中：下一条指令地址为IF.PC+4



##  BHT的历史预测功能

* 当历史预测不大于1时，认为程序不会跳转，给出IF.PC+4

* 当历史预测大于1时，认为程序会进行跳转，给出存储的对应TargetPC

* 若分支成功，在分支指令到达EX时：TargetPC == ID.PC

* 若分支失败，在分支指令到达EX时：TargetPC != ID.PC

  

##BHT根据EX.PC来存储、替换、修改预测历史

* | 逻辑含义                          | 判断                     |
  | --------------------------------- | ------------------------ |
  | 需要跳转                          | 正常程序地址 != IF.PC +4 |
  | 不需要跳转                        | 正常程序地址 == IF.PC +4 |
  | BHT执行转跳                       | ID.PC != EX.PC + 4       |
  | BHT未执行转跳                     | ID.PC == EX.PC + 4       |
  | 要插入气泡（预测错误）            | 正常程序地址 != ID.PC    |
  | 不要插入气泡（预测正确）（仅对2） | 正常程序地址 == ID.PC    |
  | 不要插入气泡（预测正确）（仅对3） | 正常程序地址 == ID.PC +8 |

* EX处出现的可能情况：

| 序号 | 情况                                                |
| ---- | --------------------------------------------------- |
| 1    | 需要跳转、未执行跳转 => 预测错误                    |
| 2    | 需要跳转、执行跳转 => 预测成功                      |
| 3    | 不需要跳转、未执行跳转 => 预测成功                  |
| 4    | 不需要跳转、执行跳转 => 预测失败                    |
| 4    | 此时正常程序地址不是IF.EX +4，因为IF.PC是错误分支， |
| 4    | 应该做一个选择，输出的正常程序地址是EX.PC + 4       |



* 要跳没跳：
  * ~~插入气泡，下一条指令地址是EX.PC的正常转跳地址~~
  * EX.PC存在于cache中：分支成功
  * ~~EX.PC不存在于cache中：找到LRU中最大的，将对应的valid、IRPC、TargetPC使能端置1，写入1、EX.PC、正常指令地址~~



* 要跳且跳
  * ~~不插入气泡，下一条指令地址由IF.PC通过BHT决定~~
  * 找到EX.PC在cache中的位置，分支成功



* 不要跳没跳：
  * ~~不插入气泡，下一条指令地址由IF.PC通过BHT决定~~
  * EX.PC存在于cache中：分支错误
  * EX.PC不存在cache中，且转跳控制信号亮（转跳语句，此次未转跳）：



* 不要跳但跳了：
  * ~~插入气泡，~~~~下一条指令地址是EX.PC+4~~
  * EX.PC存在cache中：分支错误

